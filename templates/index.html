<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自主AI智能体</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .chat-box {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
        }
        .user {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .assistant {
            background: #f1f1f1;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .search-result {
            border-left: 3px solid #4285f4;
            padding-left: 10px;
            margin: 10px 0;
        }
        .search-source {
            font-size: 0.8em;
            color: #666;
            font-weight: bold;
        }
        .search-title {
            color: #1a0dab;
            text-decoration: underline;
            display: block;
            margin: 5px 0;
        }
        .search-snippet {
            color: #545454;
            font-size: 0.9em;
        }
        .task-plan {
            background: #fff8e1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .task-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        #userInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #3367d6;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h1>自主AI智能体</h1>
        
        <div class="chat-box" id="chatBox">
            <div class="message assistant">
                <p>你好！我是你的AI助手，可以执行任务、搜索信息和制定计划。</p>
                <p>尝试输入: <code>/goal 学习Python</code> 或 <code>/execute 搜索最新AI新闻</code></p>
            </div>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="输入消息或指令 (/goal, /execute, /plan, /reflect)">
            <button id="sendButton">发送</button>
            <button id="clearButton">清空</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatBox = document.getElementById('chatBox');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const clearButton = document.getElementById('clearButton');

            function addMessage(role, content, isHtml = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                if (isHtml) {
                    messageDiv.innerHTML = content;
                } else {
                    const p = document.createElement('p');
                    p.textContent = content;
                    messageDiv.appendChild(p);
                }
                
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function displaySearchResults(results) {
                let html = '<div class="search-results"><p>🔍 搜索到以下结果:</p>';
                
                results.forEach(result => {
                    html += `
                    <div class="search-result">
                        <span class="search-source">${result.source}</span>
                        <a href="${result.link}" target="_blank" class="search-title">${result.title}</a>
                        <p class="search-snippet">${result.snippet}</p>
                    </div>`;
                });
                
                html += '</div>';
                addMessage('assistant', html, true);
            }

            function displayTaskPlan(tasks) {
                let html = '<div class="task-plan"><h3>📋 执行计划</h3>';
                
                tasks.forEach(task => {
                    html += `
                    <div class="task-item">
                        <h4>步骤 ${task.step}: ${task.description}</h4>
                        <p>预期结果: ${task.expected_outcome}</p>
                        ${task.dependencies && task.dependencies.length ? 
                            `<p>依赖: ${task.dependencies.join(', ')}</p>` : ''}
                        ${task.tools_needed && task.tools_needed.length ? 
                            `<p>工具: ${task.tools_needed.join(', ')}</p>` : ''}
                    </div>`;
                });
                
                html += '</div>';
                addMessage('assistant', html, true);
            }

            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;

                addMessage('user', message);
                userInput.value = '';
                
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message })
                    });
                    
                    const data = await response.json();
                    
                    if (data.type === 'plan') {
                        displayTaskPlan(data.tasks);
                    } else {
                        addMessage('assistant', data.response);
                    }
                } catch (error) {
                    addMessage('assistant', '出错: ' + error.message);
                }
            }

            async function clearChat() {
                try {
                    await fetch('/clear', { method: 'POST' });
                    chatBox.innerHTML = '';
                    addMessage('assistant', '对话历史已清空');
                } catch (error) {
                    console.error('清空失败:', error);
                }
            }

            sendButton.addEventListener('click', sendMessage);
            clearButton.addEventListener('click', clearChat);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>