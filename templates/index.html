<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½ä½“ - å…ƒæœç´¢ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .chat-container {
            max-width: 900px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            background: #4285f4;
            color: white;
            padding: 15px;
        }
        .chat-body {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
        }
        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }
        .user-message {
            margin-left: auto;
            background: #e3f2fd;
            border-radius: 18px 18px 0 18px;
            padding: 10px 15px;
        }
        .agent-message {
            margin-right: auto;
            background: #f1f1f1;
            border-radius: 18px 18px 18px 0;
            padding: 10px 15px;
        }
        .search-result {
            border-left: 3px solid #4285f4;
            padding-left: 10px;
            margin: 10px 0;
        }
        .search-source {
            font-size: 0.8em;
            color: #666;
            font-weight: bold;
        }
        .search-title {
            color: #1a0dab;
            text-decoration: none;
            display: block;
            margin: 5px 0;
        }
        .search-snippet {
            color: #545454;
            font-size: 0.9em;
        }
        .task-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #fff8e1;
            border-radius: 5px;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .command-help {
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="chat-container mx-auto">
            <div class="chat-header">
                <h4 class="mb-0">AIæ™ºèƒ½ä½“ (å…ƒæœç´¢ç‰ˆ)</h4>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small id="agentStatus" class="status-badge">æ­£åœ¨è¿æ¥...</small>
                    <button id="clearBtn" class="btn btn-sm btn-light">æ¸…ç©ºå¯¹è¯</button>
                </div>
            </div>
            
            <div class="chat-body" id="chatBody">
                <div class="agent-message">
                    <p>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œå…·å¤‡å…ƒæœç´¢èƒ½åŠ›ã€‚</p>
                    <p class="command-help">
                        å¯ç”¨å‘½ä»¤:<br>
                        <code>/goal [ç›®æ ‡]</code> - è®¾ç½®ç›®æ ‡<br>
                        <code>/execute [ä»»åŠ¡]</code> - æ‰§è¡Œä»»åŠ¡<br>
                        <code>/plan [ç›®æ ‡]</code> - åˆ¶å®šè®¡åˆ’<br>
                        <code>/reflect</code> - è‡ªæˆ‘åæ€<br>
                        <code>/status</code> - æŸ¥çœ‹çŠ¶æ€
                    </p>
                </div>
            </div>
            
            <div class="chat-footer p-3 bg-light">
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯æˆ–å‘½ä»¤...">
                    <button id="sendBtn" class="btn btn-primary">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatBody = document.getElementById('chatBody');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const clearBtn = document.getElementById('clearBtn');
            const agentStatus = document.getElementById('agentStatus');
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            function addMessage(role, content, isHtml = false) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${role}-message`;
                
                if (isHtml) {
                    msgDiv.innerHTML = content;
                } else {
                    msgDiv.textContent = content;
                }
                
                chatBody.appendChild(msgDiv);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            function displaySearchResults(resultsHtml) {
                const container = document.createElement('div');
                container.className = 'agent-message';
                container.innerHTML = resultsHtml;
                chatBody.appendChild(container);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
            
            // æ˜¾ç¤ºä»»åŠ¡è®¡åˆ’
            function displayTaskPlan(tasks) {
                let html = '<h5>ğŸ“‹ ä»»åŠ¡è®¡åˆ’</h5>';
                
                tasks.forEach(task => {
                    html += `
                    <div class="task-item mb-2">
                        <strong>æ­¥éª¤ ${task.step}: ${task.description}</strong>
                        <p class="mb-1">é¢„æœŸç»“æœ: ${task.expected_outcome}</p>
                        ${task.dependencies && task.dependencies.length ? 
                            `<p class="mb-1 small">ä¾èµ–: ${task.dependencies.join(', ')}</p>` : ''}
                        ${task.tools_needed && task.tools_needed.length ? 
                            `<p class="mb-0 small">å·¥å…·: ${task.tools_needed.join(', ')}</p>` : ''}
                    </div>`;
                });
                
                addMessage('agent', html, true);
            }
            
            // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
            function displayStatus(status) {
                let html = '<h5>ğŸ”„ æ™ºèƒ½ä½“çŠ¶æ€</h5>';
                html += `<p>å½“å‰ç›®æ ‡: ${status.goals.length ? status.goals[status.goals.length-1].description : 'æ— '}</p>`;
                html += `<p>è®°å¿†æ¡ç›®: ${status.memory_size}</p>`;
                html += `<p>å­¦ä¹ è®°å½•: ${status.learning_count}</p>`;
                html += `<p>å½“å‰ä»»åŠ¡: ${status.current_task || 'æ— '}</p>`;
                
                addMessage('agent', html, true);
            }
            
            // å‘é€æ¶ˆæ¯
            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;
                
                addMessage('user', message);
                messageInput.value = '';
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message })
                    });
                    
                    const data = await response.json();
                    
                    if (data.type === 'plan') {
                        displayTaskPlan(data.tasks);
                    } else if (data.type === 'status') {
                        displayStatus(data.response);
                    } else {
                        addMessage('agent', data.response);
                    }
                    
                    // æ›´æ–°çŠ¶æ€
                    updateAgentStatus();
                } catch (error) {
                    addMessage('agent', `é”™è¯¯: ${error.message}`);
                }
            }
            
            // æ›´æ–°æ™ºèƒ½ä½“çŠ¶æ€
            async function updateAgentStatus() {
                try {
                    const response = await fetch('/api/search/stats');
                    if (response.ok) {
                        const stats = await response.json();
                        let statusText = 'å°±ç»ª';
                        if (Object.keys(stats).length > 0) {
                            statusText += ' | æœç´¢: ' + 
                                Object.entries(stats).map(([k,v]) => `${k}:${v}`).join(', ');
                        }
                        agentStatus.textContent = statusText;
                    }
                } catch (error) {
                    console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                }
            }
            
            // æ¸…ç©ºå¯¹è¯
            async function clearChat() {
                try {
                    await fetch('/api/clear', { method: 'POST' });
                    chatBody.innerHTML = '';
                    addMessage('agent', 'å¯¹è¯å†å²å·²æ¸…ç©ºã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ');
                    updateAgentStatus();
                } catch (error) {
                    console.error('æ¸…ç©ºå¤±è´¥:', error);
                }
            }
            
            // äº‹ä»¶ç›‘å¬
            sendBtn.addEventListener('click', sendMessage);
            clearBtn.addEventListener('click', clearChat);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // åˆå§‹çŠ¶æ€
            updateAgentStatus();
        });
    </script>
</body>
</html>